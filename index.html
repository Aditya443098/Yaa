// APP VERSION - SUMBER TUNGGAL - UPDATE KE v1.4
const APP_VERSION = "1.4";

// ... (kode sebelumnya tetap sama) ...

// SETTINGS FUNCTIONS - DIPERBARUI
function toggleSound() {
    const soundEnabled = document.getElementById('soundToggle').checked;
    localStorage.setItem('sound_enabled', soundEnabled);
    showNotification('Pengaturan Suara', `Suara game ${soundEnabled ? 'diaktifkan' : 'dimatikan'}.`, 'info');
}

function toggleAnimation() {
    const animationEnabled = document.getElementById('animationToggle').checked;
    localStorage.setItem('animation_enabled', animationEnabled);
    showNotification('Pengaturan Animasi', `Animasi ${animationEnabled ? 'diaktifkan' : 'dimatikan'}.`, 'info');
}

function toggleDarkMode() {
    const darkModeEnabled = document.getElementById('darkModeToggle').checked;
    localStorage.setItem('dark_mode_enabled', darkModeEnabled);
    
    if (darkModeEnabled) {
        document.body.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
        document.body.style.color = '#f8f9fa';
    } else {
        document.body.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
        document.body.style.color = '#212529';
    }
    
    showNotification('Mode Tampilan', `Mode ${darkModeEnabled ? 'gelap' : 'terang'} diaktifkan.`, 'info');
}

// FITUR PENGATURAN BARU v1.4
function setVibrationIntensity() {
    const intensity = document.getElementById('vibrationIntensity').value;
    localStorage.setItem('vibration_intensity', intensity);
    showNotification('Getaran', `Intensitas getaran diatur ke ${intensity}%`, 'info');
}

function setAnimationSpeed() {
    const speed = document.getElementById('animationSpeed').value;
    localStorage.setItem('animation_speed', speed);
    document.documentElement.style.setProperty('--transition', `all ${speed}s ease`);
    showNotification('Kecepatan Animasi', `Kecepatan animasi diatur ke ${speed} detik`, 'info');
}

function setBoardColor() {
    const color = document.getElementById('boardColor').value;
    localStorage.setItem('board_color', color);
    document.documentElement.style.setProperty('--primary', color);
    
    // Update gradient colors based on primary color
    const r = parseInt(color.slice(1, 3), 16);
    const g = parseInt(color.slice(3, 5), 16);
    const b = parseInt(color.slice(5, 7), 16);
    
    // Calculate darker shade for secondary
    const secondary = `#${(r * 0.7).toString(16).padStart(2, '0')}${(g * 0.7).toString(16).padStart(2, '0')}${(b * 0.7).toString(16).padStart(2, '0')}`;
    document.documentElement.style.setProperty('--secondary', secondary);
    
    showNotification('Warna Papan', `Warna papan game diubah`, 'success');
}

function setPlayerXColor() {
    const color = document.getElementById('playerXColor').value;
    localStorage.setItem('player_x_color', color);
    document.documentElement.style.setProperty('--success', color);
    showNotification('Warna Player X', `Warna Player X diubah`, 'success');
}

function setPlayerOColor() {
    const color = document.getElementById('playerOColor').value;
    localStorage.setItem('player_o_color', color);
    document.documentElement.style.setProperty('--danger', color);
    showNotification('Warna Player O', `Warna Player O diubah`, 'success');
}

function toggleAutoSave() {
    const autoSaveEnabled = document.getElementById('autoSaveToggle').checked;
    localStorage.setItem('auto_save_enabled', autoSaveEnabled);
    showNotification('Auto Save', `Auto save ${autoSaveEnabled ? 'diaktifkan' : 'dimatikan'}`, 'info');
}

function setAutoSaveInterval() {
    const interval = document.getElementById('autoSaveInterval').value;
    localStorage.setItem('auto_save_interval', interval);
    showNotification('Interval Auto Save', `Auto save setiap ${interval} menit`, 'info');
}

function toggleGameSounds() {
    const gameSoundsEnabled = document.getElementById('gameSoundsToggle').checked;
    localStorage.setItem('game_sounds_enabled', gameSoundsEnabled);
    showNotification('Suara Game', `Suara game ${gameSoundsEnabled ? 'diaktifkan' : 'dimatikan'}`, 'info');
}

function toggleWinAnimation() {
    const winAnimationEnabled = document.getElementById('winAnimationToggle').checked;
    localStorage.setItem('win_animation_enabled', winAnimationEnabled);
    showNotification('Animasi Kemenangan', `Animasi kemenangan ${winAnimationEnabled ? 'diaktifkan' : 'dimatikan'}`, 'info');
}

function toggleHapticFeedback() {
    const hapticEnabled = document.getElementById('hapticToggle').checked;
    localStorage.setItem('haptic_feedback_enabled', hapticEnabled);
    showNotification('Feedback Haptic', `Feedback haptic ${hapticEnabled ? 'diaktifkan' : 'dimatikan'}`, 'info');
}

function setLanguage() {
    const language = document.getElementById('languageSelect').value;
    localStorage.setItem('app_language', language);
    
    // Update UI text based on language
    updateUILanguage(language);
    showNotification('Bahasa', `Bahasa diubah ke ${language === 'id' ? 'Indonesia' : 'English'}`, 'success');
}

function updateUILanguage(lang) {
    // Update text based on language
    const translations = {
        'id': {
            // Main menu
            'mainMenuTitle': 'Menu Utama',
            'playGame': 'Main Game',
            'updateGame': 'Update Game',
            'changelog': 'Riwayat Update',
            'shop': 'Shop',
            'stats': 'Statistik',
            'settings': 'Pengaturan',
            
            // Settings
            'settingsTitle': 'Pengaturan',
            'notifications': 'Notifikasi',
            'notificationsDesc': 'Izinkan notifikasi untuk mendapatkan pemberitahuan update game',
            'enableNotifications': 'Aktifkan Notifikasi',
            'disableNotifications': 'Matikan Notifikasi',
            'otherSettings': 'Pengaturan Lainnya',
            'sound': 'Suara Game',
            'animation': 'Animasi',
            'darkMode': 'Mode Gelap',
            'backToMenu': 'Kembali ke Menu',
            'logout': 'Keluar',
            
            // New settings v1.4
            'gameSettings': 'Pengaturan Game',
            'vibrationIntensity': 'Intensitas Getaran',
            'animationSpeed': 'Kecepatan Animasi',
            'boardColor': 'Warna Papan Game',
            'playerXColor': 'Warna Player X',
            'playerOColor': 'Warna Player O',
            'autoSave': 'Auto Save',
            'autoSaveInterval': 'Interval Auto Save',
            'gameSounds': 'Suara Game',
            'winAnimation': 'Animasi Kemenangan',
            'hapticFeedback': 'Feedback Haptic',
            'language': 'Bahasa',
            'resetStats': 'Reset Statistik',
            'resetAllData': 'Reset Semua Data',
            'aboutApp': 'Tentang Aplikasi',
            
            // Stats
            'statsTitle': 'Statistik',
            'totalGames': 'Total Game',
            'winsAsX': 'Menang sebagai X',
            'winsAsO': 'Menang sebagai O',
            'totalWins': 'Total Kemenangan',
            'totalLosses': 'Total Kekalahan',
            'totalDraws': 'Total Seri',
            'winRate': 'Rasio Menang',
            'currentLevel': 'Level Saat Ini',
            'coinsEarned': 'Koin Diperoleh'
        },
        'en': {
            // Main menu
            'mainMenuTitle': 'Main Menu',
            'playGame': 'Play Game',
            'updateGame': 'Update Game',
            'changelog': 'Changelog',
            'shop': 'Shop',
            'stats': 'Statistics',
            'settings': 'Settings',
            
            // Settings
            'settingsTitle': 'Settings',
            'notifications': 'Notifications',
            'notificationsDesc': 'Allow notifications to receive game update alerts',
            'enableNotifications': 'Enable Notifications',
            'disableNotifications': 'Disable Notifications',
            'otherSettings': 'Other Settings',
            'sound': 'Game Sound',
            'animation': 'Animation',
            'darkMode': 'Dark Mode',
            'backToMenu': 'Back to Menu',
            'logout': 'Logout',
            
            // New settings v1.4
            'gameSettings': 'Game Settings',
            'vibrationIntensity': 'Vibration Intensity',
            'animationSpeed': 'Animation Speed',
            'boardColor': 'Board Color',
            'playerXColor': 'Player X Color',
            'playerOColor': 'Player O Color',
            'autoSave': 'Auto Save',
            'autoSaveInterval': 'Auto Save Interval',
            'gameSounds': 'Game Sounds',
            'winAnimation': 'Win Animation',
            'hapticFeedback': 'Haptic Feedback',
            'language': 'Language',
            'resetStats': 'Reset Statistics',
            'resetAllData': 'Reset All Data',
            'aboutApp': 'About App',
            
            // Stats
            'statsTitle': 'Statistics',
            'totalGames': 'Total Games',
            'winsAsX': 'Wins as X',
            'winsAsO': 'Wins as O',
            'totalWins': 'Total Wins',
            'totalLosses': 'Total Losses',
            'totalDraws': 'Total Draws',
            'winRate': 'Win Rate',
            'currentLevel': 'Current Level',
            'coinsEarned': 'Coins Earned'
        }
    };
    
    const texts = translations[lang];
    for (const [key, value] of Object.entries(texts)) {
        const elements = document.querySelectorAll(`[data-translate="${key}"]`);
        elements.forEach(el => {
            el.textContent = value;
        });
    }
}

function resetStatistics() {
    if (confirm('Apakah Anda yakin ingin mereset semua statistik? Tindakan ini tidak dapat dibatalkan.')) {
        if (currentUser) {
            currentUser.stats = {
                totalGames: 0,
                wins: 0,
                losses: 0,
                draws: 0,
                winsAsX: 0,
                winsAsO: 0
            };
            currentUser.level = 1;
            saveUserData();
            
            gameState.scores = { X: 0, O: 0, draw: 0 };
            gameState.totalGames = 0;
            gameState.wins = 0;
            gameState.losses = 0;
            gameState.draws = 0;
            
            // Update UI
            document.getElementById('scoreX').textContent = '0';
            document.getElementById('scoreO').textContent = '0';
            document.getElementById('scoreDraw').textContent = '0';
            updateStatsDisplay();
            
            showNotification('Statistik Direset', 'Semua statistik telah direset ke nilai awal.', 'success');
        }
    }
}

function resetAllData() {
    if (confirm('PERINGATAN: Apakah Anda yakin ingin mereset SEMUA data termasuk akun, statistik, dan pengaturan? Tindakan ini tidak dapat dibatalkan.')) {
        // Clear all localStorage except update tracking
        const appVersion = localStorage.getItem('app_version');
        const lastNotifiedVersion = localStorage.getItem('last_notified_version');
        
        localStorage.clear();
        
        // Restore update tracking
        if (appVersion) localStorage.setItem('app_version', appVersion);
        if (lastNotifiedVersion) localStorage.setItem('last_notified_version', lastNotifiedVersion);
        
        // Reset current user
        currentUser = null;
        userAvatar.textContent = 'A';
        
        // Reload page
        location.reload();
    }
}

function showAboutApp() {
    const aboutHTML = `
        <div style="text-align: center; padding: 20px;">
            <h3 style="color: var(--success); margin-bottom: 15px;">Tentang Aplikasi</h3>
            <div style="font-size: 5rem; color: var(--primary); margin: 20px 0;">
                <i class="fas fa-gamepad"></i>
            </div>
            <h2>Tic Tac Toe X-O</h2>
            <p style="color: #adb5bd; margin: 10px 0;">Versi ${APP_VERSION}</p>
            <p style="margin: 15px 0;">Game Tic Tac Toe modern dengan berbagai fitur menarik</p>
            <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                <p style="margin: 5px 0;"><i class="fas fa-code"></i> Dibuat dengan HTML, CSS & JavaScript</p>
                <p style="margin: 5px 0;"><i class="fas fa-mobile-alt"></i> Responsive untuk Web & Mobile</p>
                <p style="margin: 5px 0;"><i class="fas fa-sync-alt"></i> Sistem Update Otomatis</p>
                <p style="margin: 5px 0;"><i class="fas fa-bell"></i> Notifikasi Update</p>
            </div>
            <p style="margin-top: 20px; font-size: 0.9em; color: #6c757d;">
                Â© 2023 Tic Tac Toe Game. All rights reserved.
            </p>
        </div>
    `;
    
    showNotification('Tentang Aplikasi', '', 'info');
    
    // Create modal for about
    const modal = document.createElement('div');
    modal.id = 'aboutModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    `;
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; position: relative;">
            <button id="closeAbout" style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: #adb5bd; font-size: 1.5rem; cursor: pointer;">&times;</button>
            ${aboutHTML}
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('closeAbout').addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
}

function exportData() {
    if (!currentUser) {
        showNotification('Ekspor Data', 'Anda harus login untuk mengekspor data.', 'warning');
        return;
    }
    
    const userData = {
        username: currentUser.username,
        stats: currentUser.stats,
        coins: currentUser.coins,
        level: currentUser.level,
        purchases: JSON.parse(localStorage.getItem(`user_${currentUser.username}_purchases`) || '[]'),
        settings: {
            sound_enabled: localStorage.getItem('sound_enabled'),
            animation_enabled: localStorage.getItem('animation_enabled'),
            dark_mode_enabled: localStorage.getItem('dark_mode_enabled'),
            notifications_enabled: localStorage.getItem('notifications_enabled'),
            language: localStorage.getItem('app_language')
        },
        exported_at: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(userData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `tic-tac-toe-data-${currentUser.username}-${new Date().toISOString().slice(0,10)}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification('Ekspor Data', 'Data berhasil diekspor ke file JSON.', 'success');
}

function importData() {
    if (!currentUser) {
        showNotification('Impor Data', 'Anda harus login untuk mengimpor data.', 'warning');
        return;
    }
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = e => { 
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(event) {
            try {
                const importedData = JSON.parse(event.target.result);
                
                if (!importedData.username || importedData.username !== currentUser.username) {
                    showNotification('Impor Gagal', 'Data tidak cocok dengan username Anda.', 'danger');
                    return;
                }
                
                // Update user data
                currentUser.stats = importedData.stats || currentUser.stats;
                currentUser.coins = importedData.coins || currentUser.coins;
                currentUser.level = importedData.level || currentUser.level;
                
                // Save imported purchases
                if (importedData.purchases) {
                    localStorage.setItem(`user_${currentUser.username}_purchases`, JSON.stringify(importedData.purchases));
                }
                
                // Apply settings
                if (importedData.settings) {
                    for (const [key, value] of Object.entries(importedData.settings)) {
                        if (value !== null) {
                            localStorage.setItem(key, value);
                        }
                    }
                }
                
                // Save updated user data
                saveUserData();
                
                // Reload settings
                loadSettings();
                
                // Update UI
                updateStatsDisplay();
                
                showNotification('Impor Berhasil', 'Data berhasil diimpor dari file.', 'success');
                
                // Reload page to apply settings
                setTimeout(() => location.reload(), 1500);
                
            } catch (error) {
                showNotification('Impor Gagal', 'File tidak valid atau rusak.', 'danger');
                console.error('Import error:', error);
            }
        };
        
        reader.readAsText(file);
    };
    
    input.click();
}

// Load settings from localStorage - DIPERBARUI
function loadSettings() {
    const soundEnabled = localStorage.getItem('sound_enabled');
    if (soundEnabled !== null) {
        document.getElementById('soundToggle').checked = soundEnabled === 'true';
    }
    
    const animationEnabled = localStorage.getItem('animation_enabled');
    if (animationEnabled !== null) {
        document.getElementById('animationToggle').checked = animationEnabled === 'true';
    }
    
    const darkModeEnabled = localStorage.getItem('dark_mode_enabled');
    if (darkModeEnabled !== null) {
        document.getElementById('darkModeToggle').checked = darkModeEnabled === 'true';
        if (darkModeEnabled === 'false') {
            document.body.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
            document.body.style.color = '#212529';
        }
    }
    
    // Load new settings v1.4
    const vibrationIntensity = localStorage.getItem('vibration_intensity');
    if (vibrationIntensity !== null) {
        document.getElementById('vibrationIntensity').value = vibrationIntensity;
    }
    
    const animationSpeed = localStorage.getItem('animation_speed');
    if (animationSpeed !== null) {
        document.getElementById('animationSpeed').value = animationSpeed;
        document.documentElement.style.setProperty('--transition', `all ${animationSpeed}s ease`);
    }
    
    const boardColor = localStorage.getItem('board_color');
    if (boardColor !== null) {
        document.getElementById('boardColor').value = boardColor;
        document.documentElement.style.setProperty('--primary', boardColor);
    }
    
    const playerXColor = localStorage.getItem('player_x_color');
    if (playerXColor !== null) {
        document.getElementById('playerXColor').value = playerXColor;
        document.documentElement.style.setProperty('--success', playerXColor);
    }
    
    const playerOColor = localStorage.getItem('player_o_color');
    if (playerOColor !== null) {
        document.getElementById('playerOColor').value = playerOColor;
        document.documentElement.style.setProperty('--danger', playerOColor);
    }
    
    const autoSaveEnabled = localStorage.getItem('auto_save_enabled');
    if (autoSaveEnabled !== null) {
        document.getElementById('autoSaveToggle').checked = autoSaveEnabled === 'true';
    }
    
    const autoSaveInterval = localStorage.getItem('auto_save_interval');
    if (autoSaveInterval !== null) {
        document.getElementById('autoSaveInterval').value = autoSaveInterval;
    }
    
    const gameSoundsEnabled = localStorage.getItem('game_sounds_enabled');
    if (gameSoundsEnabled !== null) {
        document.getElementById('gameSoundsToggle').checked = gameSoundsEnabled === 'true';
    }
    
    const winAnimationEnabled = localStorage.getItem('win_animation_enabled');
    if (winAnimationEnabled !== null) {
        document.getElementById('winAnimationToggle').checked = winAnimationEnabled === 'true';
    }
    
    const hapticEnabled = localStorage.getItem('haptic_feedback_enabled');
    if (hapticEnabled !== null) {
        document.getElementById('hapticToggle').checked = hapticEnabled === 'true';
    }
    
    const language = localStorage.getItem('app_language') || 'id';
    document.getElementById('languageSelect').value = language;
    updateUILanguage(language);
}

// Initialize settings
loadSettings();

// Auto-save functionality
if (localStorage.getItem('auto_save_enabled') === 'true') {
    const interval = parseInt(localStorage.getItem('auto_save_interval') || '5') * 60000; // Convert minutes to milliseconds
    setInterval(() => {
        if (currentUser && gameState.gameActive) {
            saveUserGameState();
            console.log('Auto-save completed');
        }
    }, interval);
}

// Add event listeners for new settings
document.addEventListener('DOMContentLoaded', function() {
    // Add new settings elements to DOM
    const settingsScreen = document.getElementById('settingsScreen');
    
    // Add new settings HTML
    const newSettingsHTML = `
        <div class="update-status" style="margin-top: 20px;">
            <h3 class="status-title">Pengaturan Game v1.4</h3>
            <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Intensitas Getaran</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="range" id="vibrationIntensity" min="0" max="100" value="50" style="width: 100px;">
                        <span id="vibrationValue">50%</span>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Kecepatan Animasi</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="range" id="animationSpeed" min="0.1" max="2" step="0.1" value="0.3" style="width: 100px;">
                        <span id="speedValue">0.3s</span>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Warna Papan Game</span>
                    <input type="color" id="boardColor" value="#4361ee" style="width: 50px; height: 30px;">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Warna Player X</span>
                    <input type="color" id="playerXColor" value="#4cc9f0" style="width: 50px; height: 30px;">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Warna Player O</span>
                    <input type="color" id="playerOColor" value="#f72585" style="width: 50px; height: 30px;">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Auto Save</span>
                    <label class="switch">
                        <input type="checkbox" id="autoSaveToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Interval Auto Save (menit)</span>
                    <input type="number" id="autoSaveInterval" min="1" max="60" value="5" style="width: 70px; padding: 5px; background: rgba(255,255,255,0.07); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 5px;">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Suara Game</span>
                    <label class="switch">
                        <input type="checkbox" id="gameSoundsToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Animasi Kemenangan</span>
                    <label class="switch">
                        <input type="checkbox" id="winAnimationToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Feedback Haptic</span>
                    <label class="switch">
                        <input type="checkbox" id="hapticToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Bahasa</span>
                    <select id="languageSelect" style="padding: 5px; background: rgba(255,255,255,0.07); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 5px;">
                        <option value="id">Indonesia</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <button class="btn btn-warning" id="resetStatsBtn" style="width: 48%;">Reset Statistik</button>
                    <button class="btn btn-danger" id="resetAllBtn" style="width: 48%;">Reset Semua Data</button>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <button class="btn btn-info" id="exportDataBtn" style="width: 48%;">Ekspor Data</button>
                    <button class="btn btn-info" id="importDataBtn" style="width: 48%;">Impor Data</button>
                </div>
                <div style="display: flex; justify-content: center; margin-top: 10px;">
                    <button class="btn btn-accent" id="aboutAppBtn" style="width: 100%;">Tentang Aplikasi</button>
                </div>
            </div>
        </div>
    `;
    
    // Insert new settings after existing ones
    const existingSettings = settingsScreen.querySelector('.update-status');
    if (existingSettings) {
        existingSettings.insertAdjacentHTML('afterend', newSettingsHTML);
    }
    
    // Add event listeners for new settings
    document.getElementById('vibrationIntensity')?.addEventListener('input', function() {
        document.getElementById('vibrationValue').textContent = this.value + '%';
        setVibrationIntensity();
    });
    
    document.getElementById('animationSpeed')?.addEventListener('input', function() {
        document.getElementById('speedValue').textContent = this.value + 's';
        setAnimationSpeed();
    });
    
    document.getElementById('boardColor')?.addEventListener('change', setBoardColor);
    document.getElementById('playerXColor')?.addEventListener('change', setPlayerXColor);
    document.getElementById('playerOColor')?.addEventListener('change', setPlayerOColor);
    document.getElementById('autoSaveToggle')?.addEventListener('change', toggleAutoSave);
    document.getElementById('autoSaveInterval')?.addEventListener('change', setAutoSaveInterval);
    document.getElementById('gameSoundsToggle')?.addEventListener('change', toggleGameSounds);
    document.getElementById('winAnimationToggle')?.addEventListener('change', toggleWinAnimation);
    document.getElementById('hapticToggle')?.addEventListener('change', toggleHapticFeedback);
    document.getElementById('languageSelect')?.addEventListener('change', setLanguage);
    document.getElementById('resetStatsBtn')?.addEventListener('click', resetStatistics);
    document.getElementById('resetAllBtn')?.addEventListener('click', resetAllData);
    document.getElementById('exportDataBtn')?.addEventListener('click', exportData);
    document.getElementById('importDataBtn')?.addEventListener('click', importData);
    document.getElementById('aboutAppBtn')?.addEventListener('click', showAboutApp);
    
    // Add CSS for new elements
    const newStyle = document.createElement('style');
    newStyle.textContent = `
        /* Additional styles for new settings */
        input[type="range"] {
            -webkit-appearance: none;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }
        
        input[type="color"] {
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        input[type="number"] {
            text-align: center;
        }
        
        select {
            padding: 8px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        select option {
            background: #1a1a2e;
            color: white;
        }
    `;
    document.head.appendChild(newStyle);
});

// UPDATE CHANGELOG untuk v1.4
function updateChangelog() {
    // Update changelog in update screen
    const changelogList = document.querySelector('.changelog-list');
    if (changelogList) {
        const v14Changelog = document.createElement('li');
        v14Changelog.className = 'changelog-item';
        v14Changelog.innerHTML = 'ðŸŽ® <span class="changelog-version">v1.4:</span> Penambahan fitur pengaturan lengkap';
        changelogList.prepend(v14Changelog);
    }
    
    // Update full changelog
    const fullChangelog = document.getElementById('changelogScreen')?.querySelector('.changelog-list');
    if (fullChangelog) {
        const v14FullChangelog = document.createElement('li');
        v14FullChangelog.className = 'changelog-item';
        v14FullChangelog.innerHTML = `
            <h4><span class="changelog-version">v1.4</span> - 20 Oktober 2023</h4>
            <ul style="margin-left: 20px; margin-top: 10px; color: #adb5bd;">
                <li>Penambahan fitur pengaturan lengkap dengan kustomisasi warna</li>
                <li>Pengaturan intensitas getaran dan kecepatan animasi</li>
                <li>Fitur auto-save dengan interval yang dapat diatur</li>
                <li>Dukungan multi-bahasa (Indonesia & English)</li>
                <li>Fitur ekspor dan impor data game</li>
                <li>Tombol reset statistik dan reset semua data</li>
                <li>Informasi tentang aplikasi yang lebih lengkap</li>
                <li>Pengaturan feedback haptic untuk pengalaman lebih imersif</li>
            </ul>
        `;
        fullChangelog.prepend(v14FullChangelog);
    }
}

// Call updateChangelog when page loads
updateChangelog();

// Update notification for new version
if (localStorage.getItem('app_version') !== APP_VERSION) {
    setTimeout(() => {
        showNotification('Update v1.4 Tersedia!', 'Fitur pengaturan baru telah ditambahkan. Buka menu Update untuk informasi lebih lanjut.', 'success');
    }, 3000);
}

// Add CSS for toggle switches if not exists
if (!document.querySelector('style[data-toggle-switch]')) {
    const style = document.createElement('style');
    style.setAttribute('data-toggle-switch', 'true');
    style.textContent = `
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #4361ee;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    `;
    document.head.appendChild(style);
}
