
// ===== SISTEM UPDATE GITHUB - FIXED =====
const APP_VERSION = "1.4";
const RAW_GITHUB_URL = "https://raw.githubusercontent.com/Aditya443098/Yaa/refs/heads/main/index.html";
const UPDATE_CHECK_INTERVAL = 1800000; // 30 menit

// ===== MODE DEVELOPMENT CHECK =====
const IS_LOCAL_DEVELOPMENT = window.location.hostname === 'localhost' || 
                            window.location.hostname === '127.0.0.1' ||
                            window.location.protocol === 'file:';

// ===== UPDATE SYSTEM CORE =====
class UpdateManager {
    constructor() {
        this.lastUpdateCheck = localStorage.getItem('lastUpdateCheck');
        this.forceUpdateFlag = localStorage.getItem('forceUpdateFlag');
        this.updateInProgress = false;
        this.initializedFeatures = new Set();
    }

    async initialize() {
        console.log(`üéÆ Tic Tac Toe v${APP_VERSION} - Update System Initialized`);
        
        // Tampilkan loading screen
        this.showLoadingScreen();
        
        // Setup error handling dulu
        this.setupErrorHandling();
        
        if (IS_LOCAL_DEVELOPMENT) {
            console.log('üîß Development mode detected, skipping GitHub update check');
            this.hideLoadingScreen();
            this.initializeAppFeatures();
            return;
        }
        
        try {
            await this.checkForUpdates();
            
            // Setup periodic checks
            setInterval(() => this.checkForUpdates(), UPDATE_CHECK_INTERVAL);
            
        } catch (error) {
            console.error('‚ùå Update system failed, falling back to local:', error);
            this.hideLoadingScreen();
            this.initializeAppFeatures();
        }
    }

    async checkForUpdates() {
        if (this.updateInProgress) return;
        
        const now = Date.now();
        const shouldCheck = !this.lastUpdateCheck || 
                          (now - parseInt(this.lastUpdateCheck)) > UPDATE_CHECK_INTERVAL;
        
        if (!shouldCheck && !this.forceUpdateFlag) {
            console.log('‚è≠Ô∏è Skipping update check (recently checked)');
            this.hideLoadingScreen();
            this.initializeAppFeatures();
            return;
        }
        
        console.log('üîç Checking for updates from GitHub...');
        
        try {
            const response = await fetch(`${RAW_GITHUB_URL}?t=${now}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const html = await response.text();
            const remoteVersion = this.extractVersion(html);
            
            console.log(`üìä Local: v${APP_VERSION}, Remote: v${remoteVersion}`);
            
            if (remoteVersion && remoteVersion !== APP_VERSION) {
                console.log(`üÜï Update available: v${remoteVersion}`);
                await this.handleUpdateAvailable(html, remoteVersion);
            } else {
                console.log('‚úÖ App is up to date');
                localStorage.setItem('lastUpdateCheck', now.toString());
                localStorage.removeItem('forceUpdateFlag');
                
                if (!this.initializedFeatures.size) {
                    this.hideLoadingScreen();
                    this.initializeAppFeatures();
                }
            }
            
        } catch (error) {
            console.warn('‚ö†Ô∏è Update check failed:', error);
            this.hideLoadingScreen();
            this.initializeAppFeatures();
        }
    }

    extractVersion(html) {
        // Multiple extraction methods
        const patterns = [
            /const APP_VERSION\s*=\s*["'](\d+\.\d+)["']/,
            /APP_VERSION\s*:\s*["'](\d+\.\d+)["']/,
            /Versi\s*(\d+\.\d+)/,
            /version\s*(\d+\.\d+)/i
        ];
        
        for (const pattern of patterns) {
            const match = html.match(pattern);
            if (match && match[1]) {
                return match[1];
            }
        }
        
        return null;
    }

    async handleUpdateAvailable(newHtml, remoteVersion) {
        if (this.updateInProgress) return;
        this.updateInProgress = true;
        
        // Tampilkan update notification
        const shouldUpdate = await this.showUpdateDialog(remoteVersion);
        
        if (shouldUpdate) {
            await this.performUpdate(newHtml);
        } else {
            // User chose to skip
            this.updateInProgress = false;
            localStorage.setItem('lastUpdateCheck', Date.now().toString());
            this.hideLoadingScreen();
            this.initializeAppFeatures();
        }
    }

    async performUpdate(newHtml) {
        try {
            console.log('üîÑ Performing update...');
            
            // Backup user data CRITICAL
            const userData = this.backupUserData();
            
            // Simpan ke session storage sebagai fallback
            sessionStorage.setItem('preUpdateBackup', JSON.stringify(userData));
            
            // Replace the entire document
            document.open();
            document.write(newHtml);
            document.close();
            
            // Set flag untuk restore setelah reload
            localStorage.setItem('postUpdateRestore', 'true');
            localStorage.setItem('lastUpdateCheck', Date.now().toString());
            
        } catch (error) {
            console.error('‚ùå Update failed:', error);
            
            // Fallback: reload page
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    }

    backupUserData() {
        const data = {
            timestamp: Date.now(),
            
            // Auth data
            accounts: localStorage.getItem('ticTacToeAccounts'),
            currentUser: localStorage.getItem('ticTacToeUser'),
            
            // Game progress
            gameState: localStorage.getItem('ticTacToeGame'),
            tournament: localStorage.getItem('ticTacToeTournament'),
            
            // Shop items
            purchasedItems: localStorage.getItem('ticTacToeUser') ? 
                JSON.parse(localStorage.getItem('ticTacToeUser')).purchasedItems : null,
            
            // Settings
            settings: localStorage.getItem('ticTacToeUser') ? 
                JSON.parse(localStorage.getItem('ticTacToeUser')).settings : null,
            
            // Coins
            coins: localStorage.getItem('ticTacToeUser') ? 
                JSON.parse(localStorage.getItem('ticTacToeUser')).coins : null
        };
        
        console.log('üíæ User data backed up');
        return data;
    }

    restoreUserData() {
        try {
            // Coba restore dari session storage dulu
            const backup = sessionStorage.getItem('preUpdateBackup');
            if (backup) {
                const data = JSON.parse(backup);
                
                if (data.accounts) localStorage.setItem('ticTacToeAccounts', data.accounts);
                if (data.currentUser) localStorage.setItem('ticTacToeUser', data.currentUser);
                if (data.gameState) localStorage.setItem('ticTacToeGame', data.gameState);
                if (data.tournament) localStorage.setItem('ticTacToeTournament', data.tournament);
                
                sessionStorage.removeItem('preUpdateBackup');
                console.log('‚úÖ User data restored from backup');
            }
            
            // Update version info
            localStorage.setItem('lastAppVersion', APP_VERSION);
            localStorage.removeItem('postUpdateRestore');
            
            return true;
            
        } catch (error) {
            console.error('‚ùå Restore failed:', error);
            return false;
        }
    }

    showUpdateDialog(remoteVersion) {
        return new Promise((resolve) => {
            // Create update dialog
            const dialog = document.createElement('div');
            dialog.id = 'updateDialog';
            dialog.innerHTML = `
                <div class="update-dialog-overlay">
                    <div class="update-dialog">
                        <h2>üîÑ Update Tersedia!</h2>
                        <p>Versi ${remoteVersion} tersedia (Saat ini: ${APP_VERSION})</p>
                        <p>Update akan memperbarui aplikasi dengan fitur terbaru.</p>
                        <div class="update-features">
                            <h4>Fitur baru dalam update:</h4>
                            <ul>
                                <li>‚Ä¢ Ubah Password di Pengaturan</li>
                                <li>‚Ä¢ Performance improvements</li>
                                <li>‚Ä¢ Bug fixes</li>
                            </ul>
                        </div>
                        <div class="update-actions">
                            <button id="updateNowBtn" class="btn btn-primary">
                                Update Sekarang
                            </button>
                            <button id="updateLaterBtn" class="btn btn-secondary">
                                Nanti Saja
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                .update-dialog-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(15, 23, 42, 0.95);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    backdrop-filter: blur(10px);
                }
                
                .update-dialog {
                    background: linear-gradient(135deg, #1e293b, #0f172a);
                    padding: 30px;
                    border-radius: 20px;
                    max-width: 500px;
                    width: 90%;
                    border: 2px solid #3b82f6;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5),
                                0 0 60px rgba(59, 130, 246, 0.3);
                    animation: slideIn 0.3s ease-out;
                }
                
                .update-dialog h2 {
                    color: #3b82f6;
                    margin-bottom: 15px;
                }
                
                .update-features {
                    background: rgba(59, 130, 246, 0.1);
                    padding: 15px;
                    border-radius: 10px;
                    margin: 15px 0;
                    border-left: 4px solid #3b82f6;
                }
                
                .update-features ul {
                    margin: 10px 0;
                    padding-left: 20px;
                }
                
                .update-features li {
                    margin: 5px 0;
                    color: #cbd5e1;
                }
                
                .update-actions {
                    display: flex;
                    gap: 15px;
                    margin-top: 25px;
                }
                
                .update-actions button {
                    flex: 1;
                    padding: 12px;
                }
                
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(-20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(dialog);
            
            // Event listeners
            document.getElementById('updateNowBtn').addEventListener('click', () => {
                resolve(true);
                dialog.remove();
                style.remove();
            });
            
            document.getElementById('updateLaterBtn').addEventListener('click', () => {
                resolve(false);
                dialog.remove();
                style.remove();
            });
            
            // Auto-accept after 30 seconds
            setTimeout(() => {
                if (document.contains(dialog)) {
                    resolve(true);
                    dialog.remove();
                    style.remove();
                }
            }, 30000);
        });
    }

    showLoadingScreen() {
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
            loadingScreen.style.display = 'flex';
            loadingScreen.innerHTML = `
                <div class="loader"></div>
                <h2>Tic Tac Toe Pro</h2>
                <p>Versi ${APP_VERSION}</p>
                <p class="loading-status" id="loadingStatus">Memuat aplikasi...</p>
            `;
        }
    }

    updateLoadingStatus(text) {
        const status = document.getElementById('loadingStatus');
        if (status) status.textContent = text;
    }

    hideLoadingScreen() {
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transition = 'opacity 0.5s';
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                loadingScreen.style.opacity = '1';
            }, 500);
        }
    }

    setupErrorHandling() {
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled rejection:', e.reason);
        });
    }

    // ===== INISIALISASI FITUR UTAMA =====
    initializeAppFeatures() {
        console.log('üöÄ Initializing all app features...');
        
        // Mark semua fitur sebagai belum diinisialisasi
        this.initializedFeatures.clear();
        
        // Inisialisasi berurutan
        this.initializeFeature('version-display', () => {
            this.setupVersionDisplay();
        });
        
        this.initializeFeature('auth-system', () => {
            this.setupAuthSystem();
        });
        
        this.initializeFeature('game-logic', () => {
            this.setupGameLogic();
        });
        
        this.initializeFeature('shop-system', () => {
            this.setupShopSystem();
        });
        
        this.initializeFeature('tournament-system', () => {
            this.setupTournamentSystem();
        });
        
        this.initializeFeature('settings-system', () => {
            this.setupSettingsSystem();
        });
        
        this.initializeFeature('change-password', () => {
            this.setupChangePasswordFeature();
        });
        
        this.initializeFeature('ui-elements', () => {
            this.setupUIElements();
        });
        
        // Cek login status terakhir
        setTimeout(() => {
            this.checkLoginStatus();
            console.log(`‚úÖ ${this.initializedFeatures.size} features initialized`);
        }, 100);
    }

    initializeFeature(featureName, initFunction) {
        try {
            console.log(`üîß Initializing ${featureName}...`);
            initFunction();
            this.initializedFeatures.add(featureName);
            console.log(`‚úÖ ${featureName} initialized`);
        } catch (error) {
            console.error(`‚ùå Failed to initialize ${featureName}:`, error);
        }
    }

    // ===== FITUR: DISPLAY VERSION =====
    setupVersionDisplay() {
        const versionElements = document.querySelectorAll('#versionDisplay, .version-badge');
        versionElements.forEach(el => {
            if (el) el.textContent = `Versi ${APP_VERSION}`;
        });
    }

    // ===== FITUR: AUTH SYSTEM =====
    setupAuthSystem() {
        // Setup login/register tabs
        const tabLogin = document.getElementById('tabLogin');
        const tabRegister = document.getElementById('tabRegister');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        if (tabLogin && tabRegister) {
            tabLogin.addEventListener('click', () => {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                tabLogin.classList.add('btn-primary');
                tabLogin.classList.remove('btn-secondary');
                tabRegister.classList.remove('btn-primary');
                tabRegister.classList.add('btn-secondary');
            });
            
            tabRegister.addEventListener('click', () => {
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
                tabRegister.classList.add('btn-primary');
                tabRegister.classList.remove('btn-secondary');
                tabLogin.classList.remove('btn-primary');
                tabLogin.classList.add('btn-secondary');
            });
        }
        
        // Setup login button
        const loginBtn = document.getElementById('loginBtn');
        if (loginBtn) {
            loginBtn.addEventListener('click', () => this.handleLogin());
        }
        
        // Setup register button
        const registerBtn = document.getElementById('registerBtn');
        if (registerBtn) {
            registerBtn.addEventListener('click', () => this.handleRegister());
        }
    }

    handleLogin() {
        const username = document.getElementById('loginUsername')?.value.trim();
        const password = document.getElementById('loginPassword')?.value.trim();
        
        if (!username || !password) {
            this.showNotification('Username dan password harus diisi!', 'error');
            return;
        }
        
        const accounts = JSON.parse(localStorage.getItem('ticTacToeAccounts') || '{}');
        
        if (!accounts[username]) {
            this.showNotification('Username tidak ditemukan!', 'error');
            return;
        }
        
        if (accounts[username].password !== password) {
            this.showNotification('Password salah!', 'error');
            return;
        }
        
        // Login successful
        this.userState = {
            loggedIn: true,
            username: username,
            ...accounts[username]
        };
        
        localStorage.setItem('ticTacToeUser', JSON.stringify(this.userState));
        this.showNotification('Login berhasil!', 'success');
        this.showScreen('menuContainer');
        this.updateCoinDisplay();
    }

    handleRegister() {
        const username = document.getElementById('registerUsername')?.value.trim();
        const password = document.getElementById('registerPassword')?.value.trim();
        const confirmPassword = document.getElementById('registerConfirmPassword')?.value.trim();
        
        if (!username || !password || !confirmPassword) {
            this.showNotification('Semua field harus diisi!', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            this.showNotification('Password tidak cocok!', 'error');
            return;
        }
        
        if (username.length < 3) {
            this.showNotification('Username minimal 3 karakter!', 'error');
            return;
        }
        
        if (password.length < 4) {
            this.showNotification('Password minimal 4 karakter!', 'error');
            return;
        }
        
        const accounts = JSON.parse(localStorage.getItem('ticTacToeAccounts') || '{}');
        
        if (accounts[username]) {
            this.showNotification('Username sudah digunakan!', 'error');
            return;
        }
        
        // Create new account
        accounts[username] = {
            password: password,
            coins: 100,
            purchasedItems: {
                boardThemes: ['default'],
                xColors: ['#3b82f6'],
                oColors: ['#ef4444']
            },
            settings: {
                sound: true,
                animations: true,
                theme: 'dark'
            }
        };
        
        localStorage.setItem('ticTacToeAccounts', JSON.stringify(accounts));
        
        // Auto login
        this.userState = {
            loggedIn: true,
            username: username,
            ...accounts[username]
        };
        
        localStorage.setItem('ticTacToeUser', JSON.stringify(this.userState));
        this.showNotification('Pendaftaran berhasil!', 'success');
        this.showScreen('menuContainer');
        this.updateCoinDisplay();
    }

    // ===== FITUR: CHANGE PASSWORD =====
    setupChangePasswordFeature() {
        console.log('üîß Setting up Change Password feature...');
        
        // Cari container settings
        const settingsContainer = document.getElementById('settingsContainer');
        if (!settingsContainer) {
            console.error('‚ùå Settings container not found');
            return;
        }
        
        // Cari tempat untuk menambahkan form ubah password
        // Biasanya setelah tema warna atau sebelum reset data
        const settingsGroups = settingsContainer.querySelectorAll('.settings-group');
        const lastSettingsGroup = settingsGroups[settingsGroups.length - 1];
        
        if (!lastSettingsGroup) {
            console.error('‚ùå Settings groups not found');
            return;
        }
        
        // Create change password section
        const changePasswordHTML = `
            <div class="settings-group">
                <h2>Ubah Password</h2>
                <div class="form-group">
                    <label for="currentPassword">Password Saat Ini</label>
                    <input type="password" id="currentPassword" placeholder="Masukkan password saat ini">
                </div>
                <div class="form-group">
                    <label for="newPassword">Password Baru</label>
                    <input type="password" id="newPassword" placeholder="Password baru (min. 4 karakter)">
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">Konfirmasi Password Baru</label>
                    <input type="password" id="confirmNewPassword" placeholder="Ulangi password baru">
                </div>
                <button id="changePasswordBtn" class="btn btn-primary">Ubah Password</button>
            </div>
        `;
        
        // Tambahkan sebelum tombol reset data
        const resetDataBtn = settingsContainer.querySelector('#resetGameData');
        if (resetDataBtn) {
            resetDataBtn.insertAdjacentHTML('beforebegin', changePasswordHTML);
        } else {
            lastSettingsGroup.insertAdjacentHTML('afterend', changePasswordHTML);
        }
        
        // Add event listener untuk tombol ubah password
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        if (changePasswordBtn) {
            changePasswordBtn.addEventListener('click', () => this.handleChangePassword());
            console.log('‚úÖ Change Password button added and event listener attached');
        } else {
            console.error('‚ùå Change password button not found after adding HTML');
        }
    }

    handleChangePassword() {
        console.log('üîë Processing password change...');
        
        const currentPassword = document.getElementById('currentPassword')?.value.trim();
        const newPassword = document.getElementById('newPassword')?.value.trim();
        const confirmNewPassword = document.getElementById('confirmNewPassword')?.value.trim();
        
        // Validasi
        if (!currentPassword || !newPassword || !confirmNewPassword) {
            this.showNotification('Semua field harus diisi!', 'error');
            return;
        }
        
        if (newPassword.length < 4) {
            this.showNotification('Password baru minimal 4 karakter!', 'error');
            return;
        }
        
        if (newPassword !== confirmNewPassword) {
            this.showNotification('Password baru tidak cocok!', 'error');
            return;
        }
        
        // Cek user login
        const userData = JSON.parse(localStorage.getItem('ticTacToeUser') || '{}');
        if (!userData.loggedIn) {
            this.showNotification('Anda harus login terlebih dahulu!', 'error');
            return;
        }
        
        // Cek password saat ini
        const accounts = JSON.parse(localStorage.getItem('ticTacToeAccounts') || '{}');
        const currentAccount = accounts[userData.username];
        
        if (!currentAccount || currentAccount.password !== currentPassword) {
            this.showNotification('Password saat ini salah!', 'error');
            return;
        }
        
        // Update password
        currentAccount.password = newPassword;
        accounts[userData.username] = currentAccount;
        
        // Simpan ke localStorage
        localStorage.setItem('ticTacToeAccounts', JSON.stringify(accounts));
        
        // Update user state
        userData.password = newPassword;
        localStorage.setItem('ticTacToeUser', JSON.stringify(userData));
        
        // Reset form
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmNewPassword').value = '';
        
        this.showNotification('Password berhasil diubah!', 'success');
        console.log('‚úÖ Password changed successfully');
    }

    // ===== FITUR LAINNYA (Simplified) =====
    setupGameLogic() {
        // Inisialisasi game logic dasar
        console.log('üéÆ Game logic initialized');
    }

    setupShopSystem() {
        console.log('üõí Shop system initialized');
    }

    setupTournamentSystem() {
        console.log('‚öîÔ∏è Tournament system initialized');
    }

    setupSettingsSystem() {
        console.log('‚öôÔ∏è Settings system initialized');
    }

    setupUIElements() {
        // Setup menu navigation
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const menu = e.currentTarget.dataset.menu;
                this.showScreen(`${menu}Container`);
            });
        });
        
        // Setup back buttons
        document.querySelectorAll('.back-btn, #backToMenu').forEach(btn => {
            btn.addEventListener('click', () => this.showScreen('menuContainer'));
        });
        
        console.log('üì± UI elements initialized');
    }

    // ===== UTILITY FUNCTIONS =====
    showScreen(screenId) {
        document.querySelectorAll('.container').forEach(container => {
            container.classList.add('hidden');
        });
        
        const screen = document.getElementById(screenId);
        if (screen) {
            screen.classList.remove('hidden');
            
            // Initialize specific screens
            if (screenId === 'settingsContainer') {
                this.ensureChangePasswordFeature();
            }
        }
    }

    ensureChangePasswordFeature() {
        // Pastikan fitur ubah password ada di settings
        if (!document.getElementById('changePasswordBtn')) {
            console.log('üîÑ Re-initializing change password feature...');
            this.setupChangePasswordFeature();
        }
    }

    checkLoginStatus() {
        const userData = JSON.parse(localStorage.getItem('ticTacToeUser') || '{}');
        
        if (userData.loggedIn) {
            this.showScreen('menuContainer');
        } else {
            this.showScreen('authContainer');
        }
    }

    updateCoinDisplay() {
        const userData = JSON.parse(localStorage.getItem('ticTacToeUser') || '{}');
        const coinElements = document.querySelectorAll('#coinBalance, #shopCoinBalance');
        
        coinElements.forEach(el => {
            if (el) el.textContent = userData.coins || 0;
        });
    }

    showNotification(message, type = 'info') {
        // Buat notification element jika belum ada
        let notification = document.getElementById('notification');
        
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = 'notification';
            document.body.appendChild(notification);
        }
        
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
}

// ===== INISIALISASI APLIKASI =====
// Cek jika perlu restore setelah update
if (localStorage.getItem('postUpdateRestore') === 'true') {
    const updateManager = new UpdateManager();
    if (updateManager.restoreUserData()) {
        console.log('‚úÖ Post-update restore completed');
    }
    localStorage.removeItem('postUpdateRestore');
}

// Start the application
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM fully loaded, starting app...');
    
    const updateManager = new UpdateManager();
    window.updateManager = updateManager; // Expose for debugging
    
    // Check if this is a fresh load or post-update
    const isPostUpdate = sessionStorage.getItem('justUpdated') === 'true';
    
    if (isPostUpdate) {
        console.log('üîÑ Post-update initialization');
        sessionStorage.removeItem('justUpdated');
        updateManager.hideLoadingScreen();
        updateManager.initializeAppFeatures();
    } else {
        // Normal initialization
        updateManager.initialize();
    }
    
    // Manual update trigger (for debugging)
    window.forceUpdateCheck = () => {
        localStorage.setItem('forceUpdateFlag', 'true');
        window.location.reload();
    };
});

// Fallback jika DOM sudah siap
if (document.readyState === 'interactive' || document.readyState === 'complete') {
    const updateManager = new UpdateManager();
    updateManager.initialize();
}

console.log('üöÄ Update Manager script loaded');
